#!/bin/bash

# Table Operations Menu
while true; do
    select=$(zenity --list --title="Table Operations" --radiolist \
    --column="Select" --column="Option" \
    TRUE "Create Table" \
    FALSE "List Tables" \
    FALSE "Drop Table" \
    FALSE "Back to Main Menu" --width=700 --height=500)

    case $select in
    "Create Table") # create table
        TBName=$(zenity --entry --text="Please enter table name:")
        if [[ ! $TBName =~ ^[a-zA-Z][a-zA-Z0-9_]*[a-zA-Z0-9]$ ]]; then
            zenity --error --text="Invalid table name. Must start with a letter, can contain underscores, and cannot end with an underscore."
            continue
        elif [[ -f $TBName || -f .$TBName-metadata ]]; then
            zenity --error --text="Table '$TBName' already exists."
            continue
        fi

        colNum=$(zenity --entry --text="Please enter the number of columns:")
        if [[ $colNum =~ ^0$ || ! $colNum =~ ^[0]*[1-9][0-9]*$ ]]; then
            zenity --error --text="Invalid column count. Enter only positive integers and cannot be zero alone."
            continue
        fi

        # create metadata hidden file
        flag=0
        for ((i = 1; i <= colNum; i++)); do
            colName=$(zenity --entry --text="Enter column name $i:")
            if [[ ! $colName =~ ^[a-zA-Z][a-zA-Z0-9_]*[a-zA-Z0-9]$ ]]; then
                zenity --error --text="Invalid column name. Must start with a letter, can contain underscores, and cannot end with an underscore."
                ((i--))
                continue
            fi

            colType=$(zenity --entry --text="Enter data type for '$colName' (int/str):")
            if [[ $colType != "int" && $colType != "str" ]]; then
                zenity --error a--text="Invalid data type. Allowed types: 'int', 'str'."
                ((i--))
                continue
            fi

            if [[ $flag -eq 0 ]]; then
                pkCheck=$(zenity --question --text="Make '$colName' the primary key?" --title="Primary Key" && echo "yes" || echo "no")
                if [[ $pkCheck == "yes" ]]; then
                    echo "$colName:$colType:pk" >>.$TBName-metadata
                    zenity --info --text="Column '$colName' becomes primary key of table '$TBName'"
                    flag=1
                else
                    echo "$colName:$colType" >>.$TBName-metadata
                fi
            else
                echo "$colName:$colType" >>.$TBName-metadata
            fi
        done

        touch "$TBName"
        zenity --info --text="Table '$TBName' created successfully."
        ;;
    
    "List Tables") # List Tables
        tables=$(ls -1 | grep -v "^\.")
        if [[ -z $tables ]]; then
            zenity --info --text="No tables found."
        else
            zenity --info --text="Available tables:\n$tables"
        fi
        ;;
    
    "Drop Table") # Drop Table
        TBName=$(zenity --entry --text="Please enter the name of the table to drop:")
        if [[ ! -f $TBName || ! -f .$TBName-metadata ]]; then
            zenity --error --text="Table '$TBName' does not exist."
            continue
        fi

        rm -f "$TBName" ".$TBName-metadata"
        zenity --info --text="Table '$TBName' has been dropped successfully."
        ;;
    
    "Back to Main Menu") # Back to Main Menu
        zenity --info --text="Returning to the main menu..."
        break
        ;;
    
    *) # Invalid Choice
        zenity --error --text="Invalid choice. Please select a valid option."
        ;;
    esac
done

